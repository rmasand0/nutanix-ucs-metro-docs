# =========================================================================================
# Script: deploy-node.ps1
# Description: Automates Cisco UCS Service Profile creation for Nutanix Metro Nodes.
# Version: 1.0
# Author: Rack2Cloud Principal Systems Engineer
# =========================================================================================

<#
.SYNOPSIS
    This script connects to a Cisco UCS Manager and instantiates a Service Profile 
    from a Nutanix-optimized template, then assigns it to a physical blade.

.DESCRIPTION
    Nutanix Metro Availability requires specific BIOS settings (C-States disabled) 
    and vNIC configurations (MTU 9000). This script ensures consistency across
    multi-site deployments by enforcing template-based provisioning.

.PARAMETER UcsAddress
    The IP or FQDN of your Cisco UCS Manager.
#>

# --- Configuration Variables ---
$UcsAddress = "10.10.10.50"               # Change to your UCS Manager IP
$TemplateName = "Nutanix-Metro-Template"  # Must match your UCS Template name
$OrgName = "root"                         # Target Organization
$NodeNamePrefix = "NX-METRO-S1-N"         # Site 1, Node X
$TargetChassis = "1"
$TargetSlot = "3"

# --- Import Module and Connect ---
# Note: Requires Cisco UCS PowerTool Suite installed on your workstation
Import-Module Cisco.Ucs.PowerTool -ErrorAction SilentlyContinue

Write-Host "--- Initiating Nutanix Node Deployment on UCS ---" -ForegroundColor Cyan

# Check Connection
if ($null -eq $global:DefaultUcs) {
    $Credentials = Get-Credential
    Connect-Ucs $UcsAddress -Credential $Credentials
}

# 1. Verify Template Existence
$Template = Get-UcsServiceProfile -Name $TemplateName -Type "initial-template"
if (-not $Template) {
    Write-Error "Template $TemplateName not found! Ensure your BIOS Policy is ready."
    exit
}

# 2. Instantiate Service Profile from Template
$NewProfileName = "$NodeNamePrefix$TargetSlot"
Write-Host "Creating Service Profile: $NewProfileName from $TemplateName..." -ForegroundColor Yellow

$Profile = Add-UcsServiceProfile -Name $NewProfileName -SrcTemplName $TemplateName -Descr "Nutanix Metro Node - Automated Deployment"

# 3. Assign Service Profile to Physical Blade
Write-Host "Assigning $NewProfileName to Chassis $TargetChassis Slot $TargetSlot..." -ForegroundColor Yellow
$Blade = Get-UcsBlade -ChassisId $TargetChassis -SlotId $TargetSlot

if ($Blade.AssocState -ne "unassociated") {
    Write-Warning "Blade in Chassis $TargetChassis Slot $TargetSlot is already associated! Manual intervention required."
} else {
    $Profile | Set-UcsServiceProfile -PnDn $Blade.Dn -Confirm:$false
}

# 4. Monitor Association Status
Write-Host "Monitoring Association (This usually takes 5-10 minutes)..." -ForegroundColor Cyan
do {
    $currentStatus = (Get-UcsServiceProfile -Name $NewProfileName).AssocState
    Write-Host "Current Status: $currentStatus"
    if ($currentStatus -ne "associated") { Start-Sleep -Seconds 30 }
} while ($currentStatus -ne "associated")

Write-Host "--- [SUCCESS] Deployment Complete. Node is ready for Nutanix Foundation. ---" -ForegroundColor Green

Disconnect-Ucs
